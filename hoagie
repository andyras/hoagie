#!/bin/bash

hoagie="${PWD}/hoagie.sh"

function print_help {
  echo "
  hoagie is a script to submit jobs to clusters (so far tim, radon and quest).
  
  Usage: hoagie -p PROGRAM -n NCPU -e COMMAND -d -k -l -m -q -s -h -v
  -p: specify program to be run
  -n: specify number of CPUs
  -e: specify executable or command to be run by job
  -d: dry run (don't submit job)
  -k: keep auto-generated hoagie.sh after job is done
  -l: make log files for stderr and stdout
  -m: send e-mail at beginning, end, or abortion of job
  -q: request a specific queue by name
  -s: request Seideman node (quest only)
  -h: print this help
  -v: verbose output
  "
  
  exit
}

# request a queue by name
function set_queue {
  if [[ ${HOSTNAME} =~ quser* ]]; then
    if [ -z ${QUEUE} ]; then
      # default to normal queue
      echo "#MSUB -q normal" >> $hoagie
    else
      echo "#MSUB -q ${QUEUE}" >> $hoagie
    fi
  elif [ ${HOSTNAME} == "tim.selfip.org" ]; then
    if [ ! -z ${QUEUE} ]; then
      echo "#PBS -q ${QUEUE}" >> $hoagie
    fi
  elif [ ${HOSTNAME} == "radon.theory.northwestern.edu" ]; then
    if [ ! -z ${QUEUE} ]; then
      echo "#$ -q ${QUEUE}" >> $hoagie
    fi
  fi
}

# request a maximum walltime
function set_walltime {
  if [[ ${HOSTNAME} =~ quser* ]]; then
    if [ ! -z ${WALLTIME} ]; then
      echo "#MSUB -l walltime=${WALLTIME}" >> $hoagie
    fi
  elif [ ${HOSTNAME} == "tim.selfip.org" ]; then
    if [ ! -z ${WALLTIME} ]; then
      echo "#PBS -l walltime=${WALLTIME}" >> $hoagie
    fi
  elif [ ${HOSTNAME} == "radon.theory.northwestern.edu" ]; then
    if [ ! -z ${WALLTIME} ]; then
      echo "#$ -l walltime=${WALLTIME}" >> $hoagie
    fi
  fi
}

# request Seideman node on quest
function moab_quest_seideman_node {
  echo "#MSUB -l advres=b1010" >> $hoagie
  echo "#MSUB -A b1010" >> $hoagie
  echo "#MSUB -l walltime=999:99:99:99" >> $hoagie
}

# set up SGE environment variables
function set_sge_environment_vars {
  echo "#!/bin/bash" >> $hoagie
  echo "#$ -S /bin/bash" >> $hoagie
  echo "#$ -cwd" >> $hoagie
  echo "#$ -V" >> $hoagie
  echo "#$ -N $(basename $0)_$(basename $(pwd))" >> $hoagie
  if ${EMAIL}; then
    echo "#$ -m bae -M andyras@gmail.com" >> $hoagie
  fi
}

# set up PBS environment variables
function set_pbs_environment_vars {
  echo "#!/bin/bash" >> $hoagie
  echo "#PBS -S /bin/bash" >> $hoagie
  echo "#PBS -V" >> $hoagie
  echo "#PBS -N $(basename $0)_$(basename $(pwd))" >> $hoagie
  if ${EMAIL}; then
    echo "#PBS -m bae -M andyras@gmail.com" >> $hoagie
  fi
}

# set up moab environment variables
function set_moab_environment_vars {
  echo "#!/bin/bash" >> $hoagie
  echo "#MSUB -S /bin/bash" >> $hoagie
  echo "#MSUB -V" >> $hoagie
  echo "#MSUB -N $(basename $0)_$(basename $(pwd))" >> $hoagie
  if ${EMAIL}; then
    echo "#MSUB -m bae -M andyras@gmail.com" >> $hoagie
  fi
}

# set up log files
function pbs_set_log_files {
  if ${MAKE_LOGS}; then
    echo "#PBS -o stdout.log" >> $hoagie
    echo "#PBS -e stderr.log" >> $hoagie
  else
    echo "#PBS -o /dev/null" >> $hoagie
    echo "#PBS -e /dev/null" >> $hoagie
  fi
}

# set up log files
function moab_set_log_files {
  if ${MAKE_LOGS}; then
    echo "#MSUB -o stdout.log" >> $hoagie
    echo "#MSUB -e stderr.log" >> $hoagie
  else
    echo "#MSUB -o /dev/null" >> $hoagie
    echo "#MSUB -e /dev/null" >> $hoagie
  fi
}

# set up log files
function sge_set_log_files {
  if ${MAKE_LOGS}; then
    echo "#$ -o stdout.log" >> $hoagie
    echo "#$ -e stderr.log" >> $hoagie
  else
    echo "#$ -o /dev/null" >> $hoagie
    echo "#$ -e /dev/null" >> $hoagie
  fi
}

# request multiple CPUs
function sge_request_cpus {
  if [ ! -z ${NCPU} ]; then
    echo "#$ -pe ortePE ${NCPU}" >> $hoagie
  fi
}

# request multiple CPUs
function pbs_request_cpus {
  if [ ! -z ${NCPU} ]; then
    echo "#PBS -l nodes=1:ppn=${NCPU}" >> $hoagie
  fi
}

# request multiple CPUs
function moab_request_cpus {
  if [ ! -z ${NCPU} ]; then
    echo "#MSUB -l nodes=1:ppn=${NCPU}" >> $hoagie
  fi
}

# create scratch directory
function sge_create_scratch_dir {
  echo "" >> $hoagie
  echo "# create scratch directory" >> $hoagie
  echo "echo \"create scratch directory\"" >> $hoagie
  echo "SCRATCH_JOB_DIR=\${TMPDIR}/\$(basename \${SGE_CWD_PATH})" >> $hoagie
  echo "cp -rf \${SGE_CWD_PATH} \${SCRATCH_JOB_DIR}" >> $hoagie
  if ${MAKE_LOGS}; then
    echo "rm -f \${SCRATCH_JOB_DIR}/std{err,out}.log" >> $hoagie
  fi
}

# go to directory from which job was submitted.
function pbs_go_to_working_dir {
  echo "" >> $hoagie
  echo "# going to PBS working directory" >> $hoagie
  echo "echo \"going to PBS working directory: \${PBS_O_WORKDIR}\"" >> $hoagie
  echo "cd \${PBS_O_WORKDIR}" >> $hoagie
}

# go to directory from which job was submitted.
function sge_go_to_working_dir {
  echo "" >> $hoagie
  echo "# going to SGE working directory" >> $hoagie
  echo "echo \"going to SGE working directory: \${SCRATCH_JOB_DIR}\"" >> $hoagie
  echo "cd \${SCRATCH_JOB_DIR}" >> $hoagie
}

# run the script/binary
function run_program {
  echo "" >> $hoagie
  echo "# running program" >> $hoagie
  echo "echo \"running program\"" >> $hoagie
  if [ ! -z "${EXECUTABLE}" ]; then
    echo "${EXECUTABLE}" >> $hoagie
  else
    # run whatever was the argument to this function
    echo "$1" >> $hoagie
  fi
}

# copy the job from scratch back to the original directory
function sge_copy_back_scratch {
  echo "" >> $hoagie
  echo "# copy job dir contents back to where they started" >> $hoagie
  echo "echo \"copying from scratch to original directory\"" >> $hoagie
  echo "cp -rf \${SCRATCH_JOB_DIR}/* \${SGE_CWD_PATH}/" >> $hoagie
  echo "cd \$SGE_CWD_PATH" >> $hoagie
}

# delete the runscript
function delete_runscript {
  if ${KEEP_RUNSCRIPT}; then
    :
  else
    echo "" >> $hoagie
    echo "# deleting run script" >> $hoagie
    echo "echo \"deleting run script\"" >> $hoagie
    echo "rm -f ${hoagie}" >> $hoagie
  fi
}

# submit the job
function qsub_job {
  if ${DRY_RUN}; then
    :
  else
    qsub $hoagie
  fi
}

# submit the job
function msub_job {
  if ${DRY_RUN}; then
    :
  else
    msub $hoagie
  fi
}

function dynamix_sub_ra {
  set_sge_environment_vars
  sge_set_log_files
  sge_request_cpus
  set_queue
  set_walltime
  sge_create_scratch_dir
  sge_go_to_working_dir
  run_program "sleep 5; touch me"
  #run_program "./total_dynamix"
  sge_copy_back_scratch
  delete_runscript
  qsub_job
}

function dynamix_sub_tim {
  set_pbs_environment_vars
  pbs_set_log_files
  pbs_request_cpus
  set_queue
  set_walltime
  pbs_go_to_working_dir
  run_program "sleep 5; touch me"
  #run_program "./total_dynamix"
  delete_runscript
  qsub_job
}

function dynamix_sub_quest {
  set_moab_environment_vars
  moab_set_log_files
  moab_request_cpus
  set_queue
  set_walltime
  if ${SEIDEMAN_NODE}; then
    moab_quest_seideman_node
  fi
  pbs_go_to_working_dir
  run_program "sleep 5; touch me"
  #run_program "./total_dynamix"
  delete_runscript
  msub_job
}

# define variables as empty
HELP=false
PROGRAM=""
NCPU=""
EXECUTABLE=""
DRY_RUN=false
KEEP_RUNSCRIPT=false
MAKE_LOGS=false
EMAIL=false
QUEUE=""
SEIDEMAN_NODE=false
VERBOSE=false
WALLTIME=""

while getopts ":e:n:p:q:w:dhklmsv" optname; do
  case ${optname} in
    e)
      EXECUTABLE=${OPTARG}
      ;;
    n)
      echo "requesting ${OPTARG} CPUs"
      NCPU=${OPTARG}
      ;;
    p)
      PROGRAM=${OPTARG}
      ;;
    q)
      QUEUE=${OPTARG}
      ;;
    w)
      WALLTIME=${OPTARG}
      ;;
    d)
      echo "dry run"
      DRY_RUN=true
      ;;
    h)
      HELP=true
      ;;
    k)
      KEEP_RUNSCRIPT=true
      ;;
    l)
      MAKE_LOGS=true
      ;;
    m)
      EMAIL=true
      ;;
    s)
      SEIDEMAN_NODE=true
      QUEUE="buyin"
      ;;
    v)
      VERBOSE=true
      ;;
  esac
done

if ${VERBOSE}; then
  echo "WALLTIME=${WALLTIME}"
fi

if ${HELP}; then
print_help
fi

if [ ${HOSTNAME} == "radon.theory.northwestern.edu" ]; then
  if ${VERBOSE}; then
    echo "host is radon"
  fi
  host=ra
elif [ ${HOSTNAME} == "tim.selfip.org" ]; then
  if ${VERBOSE}; then
    echo "host is tim"
  fi
  host=tim
elif [[ ${HOSTNAME} =~ quser* ]]; then
  host=quest
  if ${VERBOSE}; then
    echo "host is quest"
  fi
else
  if ${VERBOSE}; then
    echo "host is $HOSTNAME"
  fi
  echo ""
  echo "ERROR: The host is not one of the recognized hosts."
  echo ""
  print_help
fi

# at this point something will happen, so make the submission script
if [ -f $hoagie ]; then
  rm -f $hoagie
fi
touch $hoagie

# decide what to run
if ${VERBOSE}; then
  echo "program is '${PROGRAM}'"
fi
if [ -z ${PROGRAM} ]; then
  PROGRAM=dynamix
fi

if ${VERBOSE}; then
  echo "running ${PROGRAM}_sub_${host}"
fi
${PROGRAM}_sub_${host}
